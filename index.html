<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Routine Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        button {
            padding: 6px 12px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Fitness Routine Generator</h1>
    <div id="get-ready-container">Loading...</div>
    <div id="saq-container"></div>

    <script>
        const ALLOWED_EQUIPMENT = ["", "N/A", "Cones", "Ladder", "Chalk"];
        const TARGET_AREA_ORDER = ["Foot/Ankle", "Legs", "Torso", "Head/Shoulders"];
        
        let allExercises = [];
        let currentGetReady = [];
        let currentSAQ = [];

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = (values[index] || '').trim();
                });
                data.push(row);
            }
            
            return data;
        }

        function validateGetReady(rows) {
            const targetAreaCounts = {};
            for (const row of rows) {
                if (row['Target Area'] === '') {
                    return false;
                }
                targetAreaCounts[row['Target Area']] = (targetAreaCounts[row['Target Area']] || 0) + 1;
            }

            if (Object.keys(targetAreaCounts).length > 0) {
                const maxCount = Math.max(...Object.values(targetAreaCounts));
                if (maxCount > 2) {
                    return false;
                }
            }

            const familyCounts = {};
            for (const row of rows) {
                if (row['Family'] !== '') {
                    const families = row['Family'].split(',').map(f => f.trim());
                    for (const family of families) {
                        familyCounts[family] = (familyCounts[family] || 0) + 1;
                    }
                }
            }

            if (Object.keys(familyCounts).length > 0) {
                const maxCount = Math.max(...Object.values(familyCounts));
                if (maxCount > 1) {
                    return false;
                }
            }

            return true;
        }

        function createGetReady(exercises) {
            const getReadyExercises = exercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('Get Ready') && 
                ALLOWED_EQUIPMENT.includes(ex['Equipment'])
            );

            const rows = getReadyExercises;
            const nRows = 6;
            const selectedRows = [];
            
            while (selectedRows.length < nRows) {
                const candidate = rows[Math.floor(Math.random() * rows.length)];
                selectedRows.push(candidate);
                if (!validateGetReady(selectedRows)) {
                    selectedRows.pop();
                }
            }

            selectedRows.sort((a, b) => {
                const indexA = TARGET_AREA_ORDER.indexOf(a['Target Area']);
                const indexB = TARGET_AREA_ORDER.indexOf(b['Target Area']);
                return indexA - indexB;
            });

            return selectedRows;
        }

        function validateSAQ(rows) {
            const formationCounts = {};
            for (const row of rows) {
                if (row['Formation'] === '') {
                    return false;
                }
                formationCounts[row['Formation']] = (formationCounts[row['Formation']] || 0) + 1;
            }

            if (Object.keys(formationCounts).length > 0) {
                const maxCount = Math.max(...Object.values(formationCounts));
                if (maxCount > 2) {
                    return false;
                }
            }

            const familyCounts = {};
            for (const row of rows) {
                if (row['Family'] !== '') {
                    const families = row['Family'].split(',').map(f => f.trim());
                    for (const family of families) {
                        familyCounts[family] = (familyCounts[family] || 0) + 1;
                    }
                }
            }

            if (Object.keys(familyCounts).length > 0) {
                const maxCount = Math.max(...Object.values(familyCounts));
                if (maxCount > 1) {
                    return false;
                }
            }

            for (let i = 0; i < rows.length - 1; i++) {
                if (rows[i]['Formation'] === rows[i + 1]['Formation']) {
                    return false;
                }
            }

            return true;
        }

        function createSAQ(exercises) {
            const saqExercises = exercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('SAQ')
            );

            const rows = saqExercises;
            const nRows = 4;
            const selectedRows = [];
            
            while (selectedRows.length < nRows) {
                const candidate = rows[Math.floor(Math.random() * rows.length)];
                selectedRows.push(candidate);
                if (!validateSAQ(selectedRows)) {
                    selectedRows.pop();
                }
            }

            return selectedRows;
        }

        function displayTable(data, sectionType) {
            if (data.length === 0) {
                return '<p>No exercises found.</p>';
            }

            const headers = ['Name', 'Family', 'Formation', 'Target Area', 'Equipment', 'Sections', 'Comments'];
            let html = '<table><thead><tr>';
            for (const header of headers) {
                html += `<th>${header}</th>`;
            }
            html += '<th>Action</th></tr></thead><tbody>';

            for (let i = 0; i < data.length; i++) {
                html += `<tr id="${sectionType}-row-${i}">`;
                for (const header of headers) {
                    html += `<td>${data[i][header] || ''}</td>`;
                }
                html += `<td><button onclick="refreshRow('${sectionType}', ${i})">Refresh</button></td>`;
                html += '</tr>';
            }

            html += '</tbody></table>';
            return html;
        }

        function refreshGetReadyRow(index) {
            const getReadyExercises = allExercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('Get Ready') && 
                ALLOWED_EQUIPMENT.includes(ex['Equipment'])
            );

            const currentTargetArea = currentGetReady[index]['Target Area'];
            let attempts = 0;
            const maxAttempts = 100;

            while (attempts < maxAttempts) {
                const candidate = getReadyExercises[Math.floor(Math.random() * getReadyExercises.length)];
                const testRows = [...currentGetReady];
                testRows[index] = candidate;

                if (validateGetReady(testRows)) {
                    currentGetReady[index] = candidate;
                    currentGetReady.sort((a, b) => {
                        const indexA = TARGET_AREA_ORDER.indexOf(a['Target Area']);
                        const indexB = TARGET_AREA_ORDER.indexOf(b['Target Area']);
                        return indexA - indexB;
                    });
                    updateGetReadyDisplay();
                    return;
                }
                attempts++;
            }
        }

        function refreshSAQRow(index) {
            const saqExercises = allExercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('SAQ')
            );

            let attempts = 0;
            const maxAttempts = 100;

            while (attempts < maxAttempts) {
                const candidate = saqExercises[Math.floor(Math.random() * saqExercises.length)];
                const testRows = [...currentSAQ];
                testRows[index] = candidate;

                if (validateSAQ(testRows)) {
                    currentSAQ[index] = candidate;
                    updateSAQDisplay();
                    return;
                }
                attempts++;
            }
        }

        function refreshRow(sectionType, index) {
            if (sectionType === 'get-ready') {
                refreshGetReadyRow(index);
            } else if (sectionType === 'saq') {
                refreshSAQRow(index);
            }
        }

        function updateGetReadyDisplay() {
            const getReadyContainer = document.getElementById('get-ready-container');
            getReadyContainer.innerHTML = '<h2>Get Ready Exercises</h2>' + displayTable(currentGetReady, 'get-ready');
        }

        function updateSAQDisplay() {
            const saqContainer = document.getElementById('saq-container');
            saqContainer.innerHTML = '<h2>SAQ Exercises</h2>' + displayTable(currentSAQ, 'saq');
        }

        async function loadAndGenerate() {
            try {
                const response = await fetch('Strides 360 Fit4Mom Data - Exercises.csv');
                const csvText = await response.text();
                allExercises = parseCSV(csvText);
                
                currentGetReady = createGetReady(allExercises);
                const getReadyContainer = document.getElementById('get-ready-container');
                getReadyContainer.innerHTML = '<h2>Get Ready Exercises</h2>' + displayTable(currentGetReady, 'get-ready');
                
                currentSAQ = createSAQ(allExercises);
                const saqContainer = document.getElementById('saq-container');
                saqContainer.innerHTML = '<h2>SAQ Exercises</h2>' + displayTable(currentSAQ, 'saq');
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('get-ready-container').innerHTML = 
                    '<p>Error loading CSV file</p>';
            }
        }
        
        loadAndGenerate();
    </script>
</body>
</html>

