<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Routine Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        button {
            padding: 6px 12px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
        }
        button:hover {
            background-color: #45a049;
        }
        .feedback-button, .download-button {
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            margin-left: 10px;
            float: right;
        }
        .feedback-button:hover, .download-button:hover {
            background-color: #357ae8;
        }
        .download-button {
            background-color: #34a853;
        }
        .download-button:hover {
            background-color: #2d8f47;
        }
        .header-container {
            overflow: hidden;
            margin-bottom: 20px;
        }
        .class-type-toggle {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .class-type-toggle label {
            margin-right: 20px;
            font-weight: bold;
        }
        .class-type-toggle input[type="radio"] {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h1 style="float: left; margin: 0;">Fitness Routine Generator</h1>
        <button class="download-button" onclick="downloadSecondsFile()">Download</button>
        <button class="feedback-button" onclick="window.open('https://forms.gle/bez4zu2unfoSehKC9', '_blank')">Feedback</button>
    </div>
    <div class="class-type-toggle">
        <label>Class Type:</label>
        <label>
            <input type="radio" name="classType" value="inside" checked onchange="updateClassType()">
            Inside
        </label>
        <label>
            <input type="radio" name="classType" value="outside" onchange="updateClassType()">
            Outside
        </label>
    </div>
    <div id="get-ready-container">Loading...</div>
    <div id="saq-container"></div>

    <script>
        const ALLOWED_EQUIPMENT = ["", "N/A", "Cones", "Ladder", "Chalk"];
        const TARGET_AREA_ORDER = ["Foot/Ankle", "Legs", "Torso", "Head/Shoulders"];
        
        let allExercises = [];
        let currentGetReady = [];
        let currentSAQ = [];
        let classType = 'inside'; // 'inside' or 'outside'

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = (values[index] || '').trim();
                });
                data.push(row);
            }
            
            return data;
        }

        function validateGetReady(rows) {
            const targetAreaCounts = {};
            for (const row of rows) {
                if (row['Target Area'] === '') {
                    return false;
                }
                targetAreaCounts[row['Target Area']] = (targetAreaCounts[row['Target Area']] || 0) + 1;
            }

            if (Object.keys(targetAreaCounts).length > 0) {
                const maxCount = Math.max(...Object.values(targetAreaCounts));
                if (maxCount > 2) {
                    return false;
                }
            }

            const familyCounts = {};
            for (const row of rows) {
                if (row['Family'] !== '') {
                    const families = row['Family'].split(',').map(f => f.trim());
                    for (const family of families) {
                        familyCounts[family] = (familyCounts[family] || 0) + 1;
                    }
                }
            }

            if (Object.keys(familyCounts).length > 0) {
                const maxCount = Math.max(...Object.values(familyCounts));
                if (maxCount > 1) {
                    return false;
                }
            }

            return true;
        }

        function createGetReady(exercises) {
            const getReadyExercises = exercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('Get Ready') && 
                ALLOWED_EQUIPMENT.includes(ex['Equipment'])
            );

            const rows = getReadyExercises;
            const nRows = 5;
            const selectedRows = [];
            
            while (selectedRows.length < nRows) {
                const candidate = rows[Math.floor(Math.random() * rows.length)];
                selectedRows.push(candidate);
                if (!validateGetReady(selectedRows)) {
                    selectedRows.pop();
                }
            }

            selectedRows.sort((a, b) => {
                const indexA = TARGET_AREA_ORDER.indexOf(a['Target Area']);
                const indexB = TARGET_AREA_ORDER.indexOf(b['Target Area']);
                return indexA - indexB;
            });

            return selectedRows;
        }

        function validateSAQ(rows) {
            const formationCounts = {};
            for (const row of rows) {
                if (row['Formation'] === '') {
                    return false;
                }
                formationCounts[row['Formation']] = (formationCounts[row['Formation']] || 0) + 1;
            }

            if (Object.keys(formationCounts).length > 0) {
                const maxCount = Math.max(...Object.values(formationCounts));
                if (maxCount > 2) {
                    return false;
                }
            }

            const familyCounts = {};
            for (const row of rows) {
                if (row['Family'] !== '') {
                    const families = row['Family'].split(',').map(f => f.trim());
                    for (const family of families) {
                        familyCounts[family] = (familyCounts[family] || 0) + 1;
                    }
                }
            }

            if (Object.keys(familyCounts).length > 0) {
                const maxCount = Math.max(...Object.values(familyCounts));
                if (maxCount > 1) {
                    return false;
                }
            }

            for (let i = 0; i < rows.length - 1; i++) {
                if (rows[i]['Formation'] === rows[i + 1]['Formation']) {
                    return false;
                }
            }

            return true;
        }

        function createSAQ(exercises) {
            const saqExercises = exercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('SAQ')
            );

            const rows = saqExercises;
            const nRows = 4;
            const selectedRows = [];
            
            while (selectedRows.length < nRows) {
                const candidate = rows[Math.floor(Math.random() * rows.length)];
                selectedRows.push(candidate);
                if (!validateSAQ(selectedRows)) {
                    selectedRows.pop();
                }
            }

            return selectedRows;
        }

        function displayTable(data, sectionType) {
            if (data.length === 0) {
                return '<p>No exercises found.</p>';
            }

            const headers = ['Name', 'Family', 'Formation', 'Target Area', 'Equipment', 'Sections', 'Comments'];
            let html = '<table><thead><tr>';
            for (const header of headers) {
                html += `<th>${header}</th>`;
            }
            html += '<th>Action</th></tr></thead><tbody>';

            for (let i = 0; i < data.length; i++) {
                html += `<tr id="${sectionType}-row-${i}">`;
                for (const header of headers) {
                    html += `<td>${data[i][header] || ''}</td>`;
                }
                html += `<td><button onclick="refreshRow('${sectionType}', ${i})">Refresh</button></td>`;
                html += '</tr>';
            }

            html += '</tbody></table>';
            return html;
        }

        function refreshGetReadyRow(index) {
            const getReadyExercises = allExercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('Get Ready') && 
                ALLOWED_EQUIPMENT.includes(ex['Equipment'])
            );

            const currentTargetArea = currentGetReady[index]['Target Area'];
            let attempts = 0;
            const maxAttempts = 100;

            while (attempts < maxAttempts) {
                const candidate = getReadyExercises[Math.floor(Math.random() * getReadyExercises.length)];
                const testRows = [...currentGetReady];
                testRows[index] = candidate;

                if (validateGetReady(testRows)) {
                    currentGetReady[index] = candidate;
                    currentGetReady.sort((a, b) => {
                        const indexA = TARGET_AREA_ORDER.indexOf(a['Target Area']);
                        const indexB = TARGET_AREA_ORDER.indexOf(b['Target Area']);
                        return indexA - indexB;
                    });
                    updateGetReadyDisplay();
                    return;
                }
                attempts++;
            }
        }

        function refreshSAQRow(index) {
            const saqExercises = allExercises.filter(ex => 
                ex['Name'] && ex['Name'].trim() !== '' &&
                ex['Sections'].includes('SAQ')
            );

            let attempts = 0;
            const maxAttempts = 100;

            while (attempts < maxAttempts) {
                const candidate = saqExercises[Math.floor(Math.random() * saqExercises.length)];
                const testRows = [...currentSAQ];
                testRows[index] = candidate;

                if (validateSAQ(testRows)) {
                    currentSAQ[index] = candidate;
                    updateSAQDisplay();
                    return;
                }
                attempts++;
            }
        }

        function refreshRow(sectionType, index) {
            if (sectionType === 'get-ready') {
                refreshGetReadyRow(index);
            } else if (sectionType === 'saq') {
                refreshSAQRow(index);
            }
        }

        function updateGetReadyDisplay() {
            const getReadyContainer = document.getElementById('get-ready-container');
            getReadyContainer.innerHTML = '<h2>Get Ready Exercises</h2>' + displayTable(currentGetReady, 'get-ready');
        }

        function updateSAQDisplay() {
            const saqContainer = document.getElementById('saq-container');
            saqContainer.innerHTML = '<h2>SAQ Exercises</h2>' + displayTable(currentSAQ, 'saq');
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function createInterval(name, duration, color) {
            return {
                color: color,
                count: "",
                duration: duration,
                halfwayAlert: false,
                identifier: generateUUID(),
                name: name,
                rest: false,
                split: false,
                vibration: false
            };
        }

        function updateClassType() {
            const selected = document.querySelector('input[name="classType"]:checked');
            classType = selected ? selected.value : 'inside';
        }

        function getWarmUpName(number) {
            if (classType === 'outside') {
                return `Out and Back #${number}`;
            } else {
                return `TODO: Open quad #${number}`;
            }
        }

        function generateSecondsFile() {
            const intervals = [];

            // Get Ready section (color 5, 30 seconds each)
            for (const exercise of currentGetReady) {
                intervals.push(createInterval(`Get Ready ${exercise['Name']}`, 30, 5));
            }

            // Get There transition (color 0, 180 seconds)
            intervals.push(createInterval("Get There", 180, 0));

            // First warm-up run (color 8, 240 seconds) - before SAQ/cond blocks
            intervals.push(createInterval(getWarmUpName(1), 240, 8));

            // Set Up / Rest (color 6, 60 seconds)
            intervals.push(createInterval("Set Up / Rest", 60, 6));

            // 4 blocks of SAQ/Conditioning (SAQ: color 2, 60 seconds; Conditioning: color 3, 60 seconds)
            // Each block: SAQ, Cond, SAQ, Cond, Warm-up, Rest
            // Total: 8 SAQ exercises and 8 Conditioning exercises
            const numBlocks = 4;
            const saqPerBlock = 2;
            const totalSAQNeeded = numBlocks * saqPerBlock;
            
            // Use available SAQ exercises, repeat if needed to get 8 total
            for (let block = 0; block < numBlocks; block++) {
                // First SAQ and Cond in this block
                const saqIndex1 = (block * saqPerBlock) % currentSAQ.length;
                intervals.push(createInterval(`SAQ ${currentSAQ[saqIndex1]['Name']}`, 60, 2));
                intervals.push(createInterval("TODO: Conditioning Exercise", 60, 3));
                
                // Second SAQ and Cond in this block
                const saqIndex2 = (block * saqPerBlock + 1) % currentSAQ.length;
                intervals.push(createInterval(`SAQ ${currentSAQ[saqIndex2]['Name']}`, 60, 2));
                intervals.push(createInterval("TODO: Conditioning Exercise", 60, 3));
                
                // After each block, add warm-up and rest
                // For the last block (block 3, since 0-indexed), we still add warm-up 5 and rest before Relay
                // Number is block + 2 (since #1 is before blocks, then #2, #3, #4, #5)
                intervals.push(createInterval(getWarmUpName(block + 2), 240, 8));
                intervals.push(createInterval("Set Up / Rest", 60, 6));
            }

            // TODO: Add Open Q section here
            // intervals.push(createInterval("TODO: Open Q Exercise", duration, color));

            // TODO: Add Relay section (color 4, 180 seconds)
            intervals.push(createInterval("TODO: Relay Exercise", 180, 4));

            // Celebrate & Recover (color 6, 60 seconds)
            intervals.push(createInterval("Celebrate & Recover", 60, 6));

            // Get Back transition (color 0, 180 seconds)
            intervals.push(createInterval("Get Back", 180, 0));

            // TODO: Add Goodbye/Stretch section (color 5, 180 seconds)
            intervals.push(createInterval("TODO: Goodbye/Stretch Exercise", 180, 5));

            const pack = {
                _type: "pack",
                identifier: generateUUID(),
                items: [{
                    intervals: intervals,
                    identifier: generateUUID(),
                    name: "Generated Fitness Routine",
                    numberOfSets: intervals.length,
                    soundScheme: 0,
                    type: 0
                }],
                name: "Shared Timers"
            };

            return JSON.stringify(pack, null, 0);
        }

        function downloadSecondsFile() {
            const content = generateSecondsFile();
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fitness-routine.seconds';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function loadAndGenerate() {
            try {
                const response = await fetch('Strides 360 Fit4Mom Data - Exercises.csv');
                const csvText = await response.text();
                allExercises = parseCSV(csvText);
                
                currentGetReady = createGetReady(allExercises);
                const getReadyContainer = document.getElementById('get-ready-container');
                getReadyContainer.innerHTML = '<h2>Get Ready Exercises</h2>' + displayTable(currentGetReady, 'get-ready');
                
                currentSAQ = createSAQ(allExercises);
                const saqContainer = document.getElementById('saq-container');
                saqContainer.innerHTML = '<h2>SAQ Exercises</h2>' + displayTable(currentSAQ, 'saq');
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                document.getElementById('get-ready-container').innerHTML = 
                    '<p>Error loading CSV file</p>';
            }
        }
        
        loadAndGenerate();
    </script>
</body>
</html>

